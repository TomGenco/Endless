function Endless(){function F(){g=document.getElementsByTagName("canvas")[0];c=g.getContext("2d");Settings.dotSize.value=Settings.dotSize.value;D();if("rainbow"==Settings.backgroundColor.value){var a=Math.floor(360*Math.random());x=new m(a,a+360,9E5)}n=new B([new u(.5,.25,0,0,"endless",256),new u(.5,.25,200,130,"By Tom Genco",64),new u(.5,.75,0,0,"Play",128,210,140,G)],!0);y=new B([new u(0,1,15,-15,"tomgenco.com",32,180,40,function(){window.location.href="http://tomgenco.com/"}),new u(1,1,-15,-15,
"source code",32,160,40,function(){window.location.href="http://github.com/TomGenco/Endless"})],!0);r=new B([new u(0,0,15,5,"Menu",64,140,70,H),new u(1,0,-15,5,"Score: 0",64)],!1);Settings.animateMenuObjects.value&&(n.menuObjects[0].transitions=[new m(0,1,2E3,0,"opacity")],n.menuObjects[1].transitions=[new m(0,1,2E3,500,"opacity")],n.menuObjects[2].transitions=[new m(0,1,2E3,1E3,"opacity")],y.menuObjects[0].transitions=[new m(0,1,2E3,2E3,"opacity")],y.menuObjects[1].transitions=[new m(0,1,2E3,2E3,
"opacity")],r.menuObjects[0].transitions=[new m(-100,r.menuObjects[0].fixedOffsetY,1E3,Settings.animateDots.value?1E3:0,"fixedOffsetY","logistic")],r.menuObjects[1].transitions=[new m(-100,r.menuObjects[1].fixedOffsetY,1E3,Settings.animateDots.value?1100:100,"fixedOffsetY","logistic")]);e=[n,y,r];z();n.startTransitions();y.startTransitions();requestAnimationFrame(E)}function I(){g.onmousemove=function(a){var b=a.clientX;a=a.clientY;for(var f=!1,h=0;h<e.length;h++)for(var c=0;c<e[h].menuObjects.length;c++)e[h].visibility&&
e[h].menuObjects[c].onClick&&e[h].menuObjects[c].inRange(b,a)&&(f=!0);f||t&&!n.visible&&b>p-v/2&&b<p+v/2&&a>q-w/2&&a<q+w/2&&1>=(b-p+v/2)/Settings.dotSize.value%2&&1>=(a-q+w/2)/Settings.dotSize.value%2?g.style.cursor="pointer":g.removeAttribute("style")};g.onmousedown=function(a){var b=a.clientX;a=a.clientY;for(var f=0;f<e.length;f++)for(var h=0;h<e[f].menuObjects.length;h++)if(e[f].visibility&&e[f].menuObjects[h].onClick&&e[f].menuObjects[h].inRange(b,a))e[f].menuObjects[h].onClick()};g.onmouseup=
function(a){g.removeAttribute("style")};g.onblur=function(a){g.removeAttribute("style")};window.onresize=D}function D(){g.setAttribute("width",window.innerWidth);g.setAttribute("height",window.innerHeight);p=window.innerWidth/2;q=window.innerHeight/2}function z(){v=Settings.columns.value*Settings.dotSize.value*2-Settings.dotSize.value;w=Settings.rows.value*Settings.dotSize.value*2-Settings.dotSize.value}function G(){t||(A(),t=!0,r.visibility=!0,r.startTransitions());C=!1;n.visibility=!1}function H(){C=
!0;n.visibility=!0}function A(){d=[];for(var a=0;a<Settings.columns.value;a++){d[a]=[];for(var b=0;b<Settings.rows.value;b++)d[a][b]=new J((Math.floor(Math.random()*Settings.dotColors.value)*(360/Settings.dotColors.value)+Settings.hueShift.value)%360,a,b,p-v/2+Settings.dotSize.value/2+a*Settings.dotSize.value*2-p,q-w/2+Settings.dotSize.value/2+b*Settings.dotSize.value*2-q),Settings.animateDots.value&&(d[a][b].transitions=[new m(d[a][b].y-q-w/2-Settings.dotSize.value/2,d[a][b].y,Settings.dotAnimationTime.value,
Settings.dotAnimationTime.value/20*a,"y",Settings.dotAnimationType.value),new m(d[a][b].x-p-v/2-Settings.dotSize.value/2,d[a][b].x,Settings.dotAnimationTime.value,Settings.dotAnimationTime.value/20*(Settings.rows.value-b-1),"x",Settings.dotAnimationType.value)])}}function E(){Settings.acid.value&&(c.globalAlpha=.09);"rainbow"==Settings.backgroundColor.value?(x.started&&!x.finished||x.start(),c.fillStyle="hsl("+x.value%360+", 50%, 25%)"):c.fillStyle=Settings.backgroundColor.value;c.fillRect(0,0,g.width,
g.height);Settings.acid.value&&(c.globalAlpha=1);if(t)for(var a=0;a<d.length;a++)for(var b=0;b<d[a].length;b++){if(Settings.dotSize.value!=Settings.dotSize.value){Settings.dotSize.value=Settings.dotSize.value;for(var f=0;f<d.length;f++)for(var h=0;h<d[f].length;h++)d[f][h].recalculatePosition()}d[a][b].draw()}for(a=0;a<e.length;a++)e[a].visibility&&(C&&e[a]==n&&(c.fillStyle="rgba(0,0,0,.75)",c.fillRect(0,0,g.width,g.height)),e[a].draw());requestAnimationFrame(E)}var x,y,g,p,q,c,d,w,v,r,n,e,t,C,l=
function(a,b){this._value=a;this.onChange=b;this.defaultValue=a;this.reset=function(){this._value=this.defaultValue}};Object.defineProperty(l.prototype,"value",{get:function(){return this._value},set:function(a){this._value=a;if(void 0!==this.onChange)this.onChange(a)}});this.Settings={_saveToStorage:function(){for(var a in this.Entries)"_"!=a.slice(0,1)&&this.Entries[a].value==this.Entries[a].defaultValue?localStorage.removeItem("ESett--"+a):localStorage.setItem("ESett--"+a,this.Entries[a].value)},
_loadFromStorage:function(){for(var a=window.localStorage,b,f=0;f<a.length;f++)if(/^ESett--/.test(a.key(f))){b=a.getItem(a.key(f));switch(b){case "true":b=!0;break;case "false":b=!1;break;case "null":b=null;break;default:b=isNaN(parseFloat(b))?b:parseFloat(b)}try{this.Entries[a.key(f).substr(7)].defaultValue==b?localStorage.removeItem(a.key(f)):this.Entries[a.key(f).substr(7)].value=b}catch(h){console.warn('Setting "'+a.key(f).substr(7)+"\" from Local Storage doesn't exist")}}},_toString:function(){var a=
"",b;for(b in this.Entries)"_"!=b.slice(0,1)&&this.Entries[b].value!=this.Entries[b].defaultValue&&(a+=b+":"+this.Entries[b].value+";");return a.slice(0,-1)},_loadFromString:function(a){a=a.split(";");for(var b,f=0;f<a.length;f++)if(""!=a){b=a[f].split(":")[1];switch(b){case "true":b=!0;break;case "false":b=!1;break;case "null":b=null;break;default:b=isNaN(parseFloat(b))?b:parseFloat(b)}try{Settings[a[f].split(":")[0]].value=b}catch(h){console.warn('Setting "'+a[f].split(":")[0]+"\" from string doesn't exist")}}}};
var J=function(a,b,f,h,g){this.color=a||0;this.col=b;this.row=f;this.x=h;this.y=g;this.opacity=1;this.transitions=[];this.draw=function(){for(var a=0;a<this.transitions.length;a++)this.transitions[a].started||this.transitions[a].start(),this.transitions[a].started&&!this.draw["finished"+this.transitions[a].property]&&(this[this.transitions[a].property]=this.transitions[a].value,this.transitions[a].finished&&(this.draw["finished"+this.transitions[a].property]=!0));c.fillStyle="hsla("+this.color+", 100%, 50%,"+
this.opacity+")";c.beginPath();c.shadowColor="rgba(0,0,0,0)";c.arc(this.x+p,this.y+q,Settings.dotSize.value/2,0,2*Math.PI,!1);c.fill()}},u=function(a,b,f,h,d,e,l,m,n){this.relativeX=a;this.relativeY=b;this.fixedOffsetX=f;this.fixedOffsetY=h;this.text=d;this.fontSize=e;this.width=l;this.height=m;this.onClick=n;this.align=0==this.relativeX?"left":1==this.relativeX?"right":"center";this.baseline=0==this.relativeY?"top":1==this.relativeY?"bottom":"middle";this.opacity=1;this.transitions=[];this.inRange=
function(k,c){var d=g.width*a+f,e=g.height*b+h;switch(this.align){default:console.error("invalid align for MenuObject "+this.text+", using center");case "center":switch(this.baseline){default:console.error("invalid baseline for MenuObject "+this.text+", using middle");case "middle":return k>d-this.width/2&&k<d+this.width/2&&c>e-this.height/2&&c<e+this.height/2?!0:!1;case "bottom":return k>d-this.width/2&&k<d+this.width/2&&c>e-this.height&&c<e?!0:!1;case "top":return k>d-this.width/2&&k<d+this.width/
2&&c>e&&c<e+this.height?!0:!1}case "left":switch(this.baseline){default:console.error("invalid baseline for MenuObject "+this.text+", using middle");case "middle":return k>d&&k<d+this.width&&c>e-this.height/2&&c<e+this.height/2?!0:!1;case "bottom":return k>d&&k<d+this.width&&c>e-this.height&&c<e?!0:!1;case "top":return k>d&&k<d+this.width&&c>e&&c<e+this.height?!0:!1}case "right":switch(this.baseline){default:console.error("invalid baseline for MenuObject "+this.text+", using middle");case "middle":return k>
d-this.width&&k<d&&c>e-this.height/2&&c<e+this.height/2?!0:!1;case "bottom":return k>d-this.width&&k<d&&c>e-this.height&&c<e?!0:!1;case "top":return k>d-this.width&&k<d&&c>e&&c<e+this.height?!0:!1}}};this.draw=function(){if(Settings.animateMenuObjects.value)for(var a=0;a<this.transitions.length;a++)this.transitions[a].started&&!this.draw["finished"+this.transitions[a].property]&&(this[this.transitions[a].property]=this.transitions[a].value,this.transitions[a].finished&&(this.draw["finished"+this.transitions[a].property]=
!0));a=this.fontSize/32+2;c.textAlign=this.align;c.textBaseline=this.baseline;c.font=(64<=this.fontSize?"100 ":"300 ")+this.fontSize+"px Josefin Sans";c.shadowColor="black";c.shadowOffsetY=a;c.shadowOffsetX=a;c.shadowBlur=a;c.fillStyle="rgba(255, 255, 255, "+this.opacity+")";c.fillText(this.text,g.width*this.relativeX+this.fixedOffsetX,g.height*this.relativeY+this.fixedOffsetY)}},B=function(a,b){this.menuObjects=a;this.visibility=b;this.draw=function(){for(var a=0;a<this.menuObjects.length;a++)this.menuObjects[a].draw()};
this.startTransitions=function(){for(var b=0;b<a.length;b++)for(var c=0;c<a[b].transitions.length;c++)a[b].transitions[c].start()}},m=function(a,b,c,d,e,g){this.startVal=void 0===a?0:a;this.endVal=void 0===b?100:b;this.duration=c||1E3;this.delay=void 0===d?200:d;this.property=void 0===e?"opacity":e;this.motionType=void 0===g?"linear":g;this.started=this.finished=!1;this.delta=this.initTime=null;this.distance=this.endVal-this.startVal;this.start=function(){this.started=!0;this.finished=!1;var a=this;
setTimeout(function(){a.finished=!0},a.delay+a.duration);this.initTime=Date.now()}};Object.defineProperty(m.prototype,"value",{get:function(){var a;if(this.finished)return this.endVal;if(this.started){this.delta=Date.now()-this.delay-this.initTime;if(0>this.delta)return this.startVal;switch(this.motionType){default:console.error("Should be unreachable");case "linear":return a=this.delta/this.duration*this.distance+this.startVal,a>this.endVal?this.endVal:a;case "logistic":return 1/(1+Math.pow(Math.E,
-15*(this.delta/this.duration-.5)))*this.distance+this.startVal}}else return this.startVal}});(function(){var a=document.getElementsByTagName("h1")[0];a.removeAttribute("style");Settings.acid=new l(!1);Settings.animateDots=new l(!0);Settings.animateMenuObjects=new l(!0);Settings.backgroundColor=new l("rainbow");Settings.columns=new l(10,function(){z();t&&A()});Settings.dotAnimationTime=new l(1E3);Settings.dotAnimationType=new l("logistic");Settings.dotColors=new l(10,function(){t&&A()});Settings.dotSize=
new l(40,function(){if(t){z();for(var a=0;a<d.length;a++)for(var c=0;c<d[a].length;c++)d[a][c].x=p-v/2+Settings.dotSize.value/2+a*Settings.dotSize.value*2-p,d[a][c].y=q-w/2+Settings.dotSize.value/2+c*Settings.dotSize.value*2-q}});Settings.hueShift=new l(70);Settings.rows=new l(10,function(){z();t&&A()});window.localStorage?Settings._loadFromStorage():console.error("This browser doesn't support Web Storage, so settings and statistics cannot be saved to browser.");setTimeout(function(){F();I();a.setAttribute("style",
"display:none;")},300)})()}window.onload=Endless;
